# STATE.yaml v9.0-claude-optimized
# Machine-optimized context for Claude - CHECK FIRST EVERY SESSION
# Symbols: ✓=done ∇=todo ❌=broken λ=limitation †=workaround ‡=critical
# Updated: 2025-08-03

SYSTEM_STATUS:
  PRODUCTION: ✓rtm.fly.dev[port_8081,working_in_claude_ai]
  BUILD: ✓passing[make_build-rtm]
  TESTS: ✓passing[393_lines_coverage]
  DEPLOYMENT: ✓fly.io[persistent_sqlite,oauth_working]

ACTIVE_SERVERS:
  rtm:
    path: cmd/rtm/main.go
    status: ✓production_ready
    endpoint: https://rtm.fly.dev/mcp
    features: [8_tools,7_resources,batch_operations,progress_tracking]
    
  core:
    path: cmd/core/main.go  
    status: ✓demo_server[port_8080]
    role: reference_implementation
    
  spektrix:
    path: cmd/spektrix/main.go
    status: ∇not_implemented
    priority: P2
    
CRITICAL_ISSUES:
  RTM_RRULE_PARSING:
    problem: json_unmarshal_error_on_recurring_tasks
    solution: change_RRule_field_to_json.RawMessage
    file: internal/rtm/client.go
    priority: P0_BLOCKING
    
  SECURE_CREDENTIALS:
    problem: API_keys_stored_in_environment_variables
    solution: implement_keyring_library_for_secure_storage
    priority: P1_SECURITY
    
  RTM_TASK_VOLUME:
    problem: too_many_tasks_returned_causes_UI_freeze
    solution: server_side_pagination_and_filtering
    priority: P1_UX

NEXT_ACTIONS:
  1_DEPLOY: make deploy-rtm[with_batch_tools]
  2_FIX: RTM_RRULE_parsing_bug
  3_IMPLEMENT: task_results_cache
  4_BUILD: spektrix_server
  5_EXTRACT: shared_infrastructure_package

ARCHITECTURE_DECISIONS:
  MCP_OAUTH_PATTERN:
    current: march_2025_spec[server_as_auth_and_resource]
    new_spec: june_2025[separate_auth_server]
    decision: maintain_current_until_claude_requirements_clear
    
  LONGRUNNING_TASKS:
    status: ✓production_ready
    implementation: custom_task_manager_with_progress
    limitation: mcp-go_lacks_notification_transport
    
  ERROR_HANDLING:
    current: basic_fmt.Errorf
    needed: stdlib_error_wrapping+slog[phase_1_immediate]
    future: cockroachdb/errors[optional_if_needed]
    priority: P1_QUALITY
    extent: widespread_context_loss_in_error_returns
    strategy: see_BACKLOG_FEATURES.error_handling_infrastructure

RTM_CAPABILITIES:
  TOOLS_IMPLEMENTED: 
    - rtm_auth_url
    - rtm_lists  
    - rtm_search
    - rtm_quick_add
    - rtm_update
    - rtm_complete
    - rtm_manage_list
    - rtm_debug[internal]
    
  BATCH_TOOLS_READY:
    - set_rtm_tasks_due_date
    - set_rtm_tasks_priority
    - add_rtm_tags_to_tasks
    - complete_rtm_tasks_batch
    - check_rtm_job_status
    
  RESOURCES_WORKING:
    - rtm://today
    - rtm://inbox
    - rtm://overdue
    - rtm://week
    - rtm://lists
    - rtm://lists/{name}
    - rtm://smart/{name}

BACKLOG_FEATURES:
  search_rtm_tasks_smart: saved_queries_and_presets
  analyze_rtm_task_context: intelligent_tagging
  create_rtm_task_smart: auto_tag_and_prioritize
  rtm_contacts_resource: structured_contact_data
  
  error_handling_infrastructure:
    priority: P1_QUALITY
    description: visibility_to_prevention_to_self_healing_pipeline
    phases:
      phase_1_visibility:
        effort: 1_day
        changes:
          - wrap_errors_with_context_using_fmt.Errorf
          - add_slog_structured_logging
          - no_new_dependencies
        example: fmt.Errorf("rtm.GetTasks: %w", err)
        
      phase_2_classification:
        effort: 2_days
        changes:
          - create_MCPError_type_with_Kind_and_Context
          - classify_RTM_errors_by_code
          - detect_protocol_oauth_ratelimit_patterns
        error_kinds:
          - ErrRateLimit[code_98]
          - ErrAuthExpired[code_101]
          - ErrProtocolMismatch
          - ErrProgressLost
          - ErrResourceLocked
          
      phase_3_self_healing:
        effort: 1_week
        capabilities:
          - retry_strategies_per_error_type
          - circuit_breakers_for_rate_limits
          - automatic_token_refresh_on_auth_errors
          - protocol_version_downgrade_on_mismatch
          - exponential_backoff_for_transient_errors
        recovery_patterns:
          rate_limit: exponential_backoff_with_jitter
          auth_expired: refresh_token_and_retry
          protocol_mismatch: downgrade_version
          network_timeout: retry_with_increased_timeout
          
    benefits:
      - every_failure_observable_and_categorized
      - patterns_trigger_proactive_measures
      - most_transient_errors_recover_automatically
      - MCP_protocol_errors_dont_cascade_to_clients
      
    implementation_note: |
      Start with Phase 1 using stdlib only. This gives immediate
      visibility with zero dependencies. Phase 2-3 can be deferred
      until error patterns are understood from production logs.

PROJECT_STRUCTURE:
  internal/:
    rtm/: ✓complete[oauth,client,handlers,batch]
    longrunning/: ✓complete[manager,task,progress,cancellation]
    core/: ✓infrastructure.go[shared_setup]
    spektrix/: ∇skeleton_only
    debug/: ✓working[interceptor,storage]
    auth/: ✓working[oauth,csrf,tokens]
    testutil/: ✓test_helpers
    
  cmd/:
    rtm/: ✓production_server
    core/: ✓demo_server
    spektrix/: ∇not_implemented
    oauth_spec_test/: ✓compliance_tester
    
  docs/:
    STATE.yaml: THIS_FILE
    AUTH_FLOWS.yaml: oauth_patterns_reference
    LONGRUNNING_TASKS.md: implementation_guide
    RTM_BACKLOG.yaml: detailed_feature_backlog

DEPENDENCIES:
  mcp-go: v0.34.1[limited_progress_support]
  go: 1.22.3
  sqlite: production_storage
  fly.io: deployment_platform

SESSION_CHECKLIST:
  [ ] Check this STATE.yaml first
  [ ] Check actual code, not assumptions
  [ ] No quick fixes - solve root causes
  [ ] Test before claiming complete
  [ ] Update this file with changes

CODE_REVIEW_FALSE_POSITIVES:
  # 2025-08-03 Q-Go review claimed concurrency issues - VERIFIED FALSE
  task_race_conditions: ✓proper_mutex_protection_throughout
  oauth_deadlock_risk: ✓single_mutex_no_nesting_found  
  goroutine_leaks: ✓proper_cleanup_with_defer_and_timeouts
  analysis: internal/longrunning+rtm/oauth_adapter_have_correct_patterns
  
VALID_CODE_ISSUES:
  file_naming:
    - internal/auth/token_store_sqlite.go.removed[use_archive_dir]
    - internal/debug/validation_interceptor.go.disabled[use_build_tags]
    - cmd/test-examples-server/main.go[hyphen_violates_convention]
    priority: P2_CLEANUP
    
  batch_task_cache:
    problem: getCachedTasksByPositions_not_implemented
    file: internal/rtm/batch_handlers.go
    solution: implement_proper_task_cache_after_search
    priority: P2_FUNCTIONALITY

  documentation_improvements:
    status: ✓COMPLETED_2025-08-03
    changes_applied:
      - Added_package_comments_to_all_packages
      - Documented_exported_functions_with_params_and_returns
      - Added_field_docs_to_Client_Task_List_structs
      - Fixed_TODO_format_to_use_TODO(vcto)_standard
      - Improved_Manager_and_Task_documentation
    files_modified: 7

# ARCHIVED_ISSUES moved to docs/HISTORY.md:
# - Race conditions (FIXED 2025-08-03)
# - OAuth flow issues (FIXED 2025-08-02)  
# - Thread safety (FIXED 2025-08-03)
# - Infrastructure gaps (FIXED 2025-07-29)