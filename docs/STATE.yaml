# STATE.yaml v10.0-claude-optimized
# Machine-optimized context for Claude - CHECK FIRST EVERY SESSION
# Symbols: ✓=done ∇=todo ❌=broken λ=limitation †=workaround ‡=critical
# Updated: 2025-08-07T11:00:00-05:00

SYSTEM_STATUS:
  BUILD: ✓fixed[package_declarations_corrected]
  PRODUCTION: ✓ready[claude_registration_compliant]
  TESTS: ✓fixed[separated_oauth_compliance_from_protocol_tests]
  DEPLOYMENT: ✓ready[make test && make deploy-rtm]

ACTIVE_SERVERS:
  rtm:
    path: cmd/rtm/main.go
    status: ✓enhanced[pagination+rate_limiter+oauth_compliant]
    endpoint: https://rtm.fly.dev/mcp
    features: [8_tools,7_resources,batch_operations,progress_tracking,search_pagination,smart_rate_limiting,claude_oauth_ready]
    oauth_endpoints:
      - /authorize
      - /token  
      - /.well-known/oauth-protected-resource
      - /.well-known/oauth-authorization-server
    
  core:
    path: cmd/core/main.go  
    status: ✓demo_server[port_8080]
    role: reference_implementation
    
  spektrix:
    path: cmd/spektrix/main.go
    status: ∇not_implemented
    priority: P2
    
CRITICAL_ISSUES:
  
  OAUTH_INTERMEDIATE_PAGE_MYSTERY: 
    problem: OAuth_flow_showing_intermediate_page_causing_Claude_timeout
    status: ∇investigated_fix_applied_needs_deployment_verification
    discovery_date: 2025-08-07
    symptoms:
      - Claude_shows_Connect_button_after_adding_RTM
      - Intermediate_page_appears_with_"Open_Remember_The_Milk"_button
      - Page_asks_user_to_open_RTM_in_new_tab_then_return
      - Claude_times_out_waiting_for_OAuth_redirect
    investigation_findings:
      - intermediate_page_HTML_not_found_in_current_codebase
      - page_shows_3_step_process_incompatible_with_OAuth
      - suggests_real_RTM_auth_flow_being_triggered_not_OAuth_adapter
    root_causes_identified:
      mixing_auth_flows: two_incompatible_auth_systems_present
      rtm_real_auth: client.AuthURL_generates_real_RTM_frob_auth_URL
      oauth_adapter: fake_OAuth_flow_for_Claude_API_key_collection
      confusion_point: something_triggering_real_RTM_auth_not_OAuth
    fix_applied:
      file: internal/auth/oauth_adapter.go
      change: ensured_immediate_redirect_after_API_key_submission
      removed: any_intermediate_pages_or_success_pages
      emphasis: added_clear_comments_about_no_intermediate_steps
    next_actions:
      1_verify_deployment: check_what_code_is_actually_deployed
      2_clear_cache: browser_cache_might_show_old_version
      3_check_logs: fly_logs_-a_rtm_during_connection_attempt
      4_ssh_inspection: fly_ssh_console_-a_rtm_to_check_deployed_code
      5_test_flow: try_connection_after_deployment_verification
    
  SECURE_CREDENTIALS:
    problem: API_keys_stored_in_environment_variables
    solution: implement_keyring_library_for_secure_storage
    priority: P2_SECURITY
    note: deprioritized_as_ENV_vars_work_for_now

NEXT_ACTIONS:
  1_DEBUG_OAUTH_MYSTERY: find_source_of_intermediate_page
  2_VERIFY_DEPLOYMENT: ensure_fixed_oauth_adapter_is_deployed
  3_CLEAR_BROWSER_STATE: clear_cache_cookies_try_fresh
  4_MONITOR_LIVE: fly_logs_-a_rtm_while_testing_connection
  5_SSH_VERIFY: check_deployed_code_matches_local_fixes

DEBUG_COMMANDS_FOR_OAUTH_ISSUE:
  check_deployed_version:
    - fly ssh console -a rtm
    - cat /app/internal/auth/oauth_adapter.go | grep -A5 "CRITICAL"
    - exit
  monitor_live_connection:
    - make monitor-oauth  # in one terminal
    - Try Claude connection in browser
    - Watch for [OAuth] prefixed logs
  check_production_logs:
    - fly logs -a rtm --since 10m
    - Look for "Authorize request" and "Form submission" logs
  test_oauth_endpoints:
    - curl https://rtm.fly.dev/.well-known/oauth-authorization-server
    - Should show authorization_endpoint and token_endpoint
  clear_browser_state:
    - Clear all cookies for claude.ai
    - Clear all cookies for rtm.fly.dev
    - Hard refresh (Cmd+Shift+R)
  deployment:
    - make deploy-rtm  # deploy latest code
    - fly status -a rtm  # verify deployment complete

OAUTH_ARCHITECTURE_CLARIFICATION:
  intended_flow_for_claude:
    1_claude_opens: https://rtm.fly.dev/oauth/authorize
    2_server_shows: API_key_input_form_NOT_RTM_redirect
    3_user_enters: RTM_API_key_and_submits
    4_server_redirects: immediately_back_to_claude_with_auth_code
    5_claude_exchanges: auth_code_for_bearer_token_at_/oauth/token
    6_server_maps: bearer_token_to_stored_RTM_API_key
    7_all_requests: use_bearer_token_which_server_translates_to_API_key
  what_should_NOT_happen:
    - NO_redirect_to_rememberthemilk.com
    - NO_frob_based_authentication
    - NO_intermediate_pages_with_buttons
    - NO_new_tabs_or_windows
    - NO_"Open_RTM"_or_"I've_Authorized"_buttons
    - NO_multi_step_process_requiring_user_to_return
  confusion_source:
    real_rtm_auth: internal/rtm/client.go_has_AuthURL_for_real_RTM
    oauth_adapter: internal/auth/oauth_adapter.go_is_fake_OAuth
    mixing_risk: rtm_auth_url_tool_should_NEVER_be_used_with_Claude
    proper_separation: OAuth_adapter_completely_replaces_RTM_auth_for_Claude

ARCHITECTURE_DECISIONS:
  MCP_OAUTH_PATTERN:
    current: march_2025_spec[server_as_auth_and_resource]
    new_spec: june_2025[separate_auth_server]
    decision: maintain_current_until_claude_requirements_clear
    
  LONGRUNNING_TASKS:
    status: ✓production_ready
    implementation: custom_task_manager_with_progress
    limitation: mcp-go_lacks_notification_transport
    
  ERROR_HANDLING:
    current: basic_fmt.Errorf
    needed: stdlib_error_wrapping+slog[phase_1_immediate]
    future: cockroachdb/errors[optional_if_needed]
    priority: P1_QUALITY
    extent: widespread_context_loss_in_error_returns
    strategy: see_BACKLOG_FEATURES.error_handling_infrastructure

RTM_CAPABILITIES:
  TOOLS_IMPLEMENTED: 
    - rtm_auth_url
    - rtm_lists  
    - rtm_search
    - rtm_quick_add
    - rtm_update
    - rtm_complete
    - rtm_manage_list
    - rtm_debug[internal]
    
  BATCH_TOOLS_READY:
    - set_rtm_tasks_due_date
    - set_rtm_tasks_priority
    - add_rtm_tags_to_tasks
    - complete_rtm_tasks_batch
    - check_rtm_job_status
    
  RESOURCES_WORKING:
    - rtm://today
    - rtm://inbox
    - rtm://overdue
    - rtm://week
    - rtm://lists
    - rtm://lists/{name}
    - rtm://smart/{name}

BACKLOG_FEATURES:
  rtm_bulk_add: natural_language_list_addition
  rtm_bulk_complete: complete_filtered_tasks
  rtm_bulk_update: batch_property_changes
  rtm_migrate_tasks: move_between_lists
  analyze_rtm_task_context: intelligent_tagging
  create_rtm_task_smart: auto_tag_and_prioritize
  rtm_contacts_resource: structured_contact_data
  
  error_handling_infrastructure:
    priority: P1_QUALITY
    description: visibility_to_prevention_to_self_healing_pipeline
    phases:
      phase_1_visibility:
        effort: 1_day
        changes:
          - wrap_errors_with_context_using_fmt.Errorf
          - add_slog_structured_logging
          - no_new_dependencies
        example: fmt.Errorf("rtm.GetTasks: %w", err)
        
      phase_2_classification:
        effort: 2_days
        changes:
          - create_MCPError_type_with_Kind_and_Context
          - classify_RTM_errors_by_code
          - detect_protocol_oauth_ratelimit_patterns
        error_kinds:
          - ErrRateLimit[code_98]
          - ErrAuthExpired[code_101]
          - ErrProtocolMismatch
          - ErrProgressLost
          - ErrResourceLocked
          
      phase_3_self_healing:
        effort: 1_week
        capabilities:
          - retry_strategies_per_error_type
          - circuit_breakers_for_rate_limits
          - automatic_token_refresh_on_auth_errors
          - protocol_version_downgrade_on_mismatch
          - exponential_backoff_for_transient_errors
        recovery_patterns:
          rate_limit: exponential_backoff_with_jitter
          auth_expired: refresh_token_and_retry
          protocol_mismatch: downgrade_version
          network_timeout: retry_with_increased_timeout
          
    benefits:
      - every_failure_observable_and_categorized
      - patterns_trigger_proactive_measures
      - most_transient_errors_recover_automatically
      - MCP_protocol_errors_dont_cascade_to_clients
      
    implementation_note: |
      Start with Phase 1 using stdlib only. This gives immediate
      visibility with zero dependencies. Phase 2-3 can be deferred
      until error patterns are understood from production logs.

PROJECT_STRUCTURE:
  internal/:
    rtm/: ✓enhanced[oauth,client,handlers,batch,rate_limiter]
    longrunning/: ✓complete[manager,task,progress,cancellation]
    core/: ✓infrastructure.go[shared_setup]
    spektrix/: ∇skeleton_only
    debug/: ✓working[interceptor,storage]
    auth/: ✓working[oauth,csrf,tokens]
    testutil/: ✓test_helpers
    
  cmd/:
    rtm/: ✓production_server
    core/: ✓demo_server
    spektrix/: ∇not_implemented
    oauth_spec_test/: ✓compliance_tester
    
  docs/:
    STATE.yaml: THIS_FILE
    AUTH_FLOWS.yaml: oauth_patterns_reference
    LONGRUNNING_TASKS.md: implementation_guide
    RTM_BACKLOG.yaml: detailed_feature_backlog

DEPENDENCIES:
  mcp-go: v0.34.1[limited_progress_support]
  go: 1.22.3
  sqlite: production_storage
  fly.io: deployment_platform

SESSION_CHECKLIST:
  [ ] Check this STATE.yaml first
  [ ] Check actual code, not assumptions
  [ ] No quick fixes - solve root causes
  [ ] Test before claiming complete
  [ ] Update this file with changes

TEST_ARCHITECTURE:
  dual_mode_approach:
    rationale: oauth_and_protocol_tests_have_different_requirements
    implementation:
      general_tests:
        file: tests/integration/mcp_integration_test.go
        mode: --disable-auth
        port: 8080
        purpose: test_MCP_protocol_compliance
        covers: [tools,resources,prompts,error_handling,concurrency]
      oauth_tests:
        file: tests/integration/claude_oauth_compliance_test.go  
        mode: auth_enabled_separate_server
        port: 8081
        purpose: test_Claude.ai_OAuth_requirements
        covers: [401_responses,WWW-Authenticate,discovery_endpoints,content-type]
        features:
          - starts_own_server_with_auth_enabled
          - uses_t.Run_for_clean_test_names
          - t.Cleanup_for_server_lifecycle
    benefits:
      - clear_separation_of_concerns
      - faster_test_execution
      - easier_debugging
      - independent_test_failures
      - parallel_test_execution_possible

CODE_REVIEW_FALSE_POSITIVES:
  # 2025-08-03 Q-Go review - MOSTLY FALSE except type assertion
  task_race_conditions: ✓proper_mutex_protection_throughout
  oauth_deadlock_risk: ✓single_mutex_no_nesting_found  
  goroutine_leaks: †partial[token_store_leak_fixed_2025-08-05]
  analysis: most_concurrency_claims_false_but_found_real_issues
  
RECENT_FIXES_2025_08_07:
  
  oauth_test_hanging_fix:
    problem: tests_hanging_because_callback_server_starts_automatically
    symptom: signal_interrupt_when_running_unit_tests
    solution: prevent_callback_server_auto_start_during_tests
    implementation:
      - check_GO_TEST_env_var_before_starting_callback_server
      - set_GO_TEST=1_in_all_Makefile_test_targets
      - added_StartCallbackServer_and_StopCallbackServer_methods
      - updated_tests_to_explicitly_start_server_when_needed
    files_modified:
      - internal/auth/oauth_adapter.go
      - internal/auth/oauth_callback_test.go[3_tests_updated]
      - Makefile[all_test_targets]
    impact: tests_now_run_without_hanging
    test_fixes:
      - TestOAuthCallbackServer_ValidatesStateTokens: removed_unnecessary_stop
      - TestOAuthCallbackServer_StartsAndStops: now_starts_server_explicitly
      - TestOAuthCallbackServer_ProcessesCallback: now_starts_server_explicitly
    
  oauth_endpoint_urls_fix:
    problem: oauth_discovery_metadata_had_wrong_endpoint_URLs
    diagnostic_output:
      - authorization_endpoint: https://rtm.fly.dev/authorize[WRONG]
      - token_endpoint: https://rtm.fly.dev/token[WRONG]
    solution: fixed_URLs_in_setupRTMWellKnownEndpoints
    corrected_to:
      - authorization_endpoint: https://rtm.fly.dev/oauth/authorize
      - token_endpoint: https://rtm.fly.dev/oauth/token
    files_modified: internal/core/infrastructure.go
    impact: Claude_can_now_find_correct_OAuth_endpoints
    
  missing_www_authenticate_header_fix:
    problem: WWW-Authenticate_header_missing_when_invalid_token_provided
    diagnostic_output: "✗ Missing WWW-Authenticate header on 401 response"
    solution: added_WWW-Authenticate_header_for_invalid_token_401s
    files_modified: internal/core/infrastructure.go[rtmAuthMiddleware]
    impact: all_401_responses_now_RFC_compliant
    test: make diagnose-prod after deployment will show ✓

RECENT_FIXES_2025_08_06:
  
  oauth_diagnostics_suite:
    problem: unclear_why_Claude_shows_Connect_button_after_successful_connection
    solution: comprehensive_diagnostic_and_monitoring_tools
    implementation:
      diagnostic_tools_created:
        - scripts/diagnostics/oauth_trace.go[tests_all_oauth_endpoints]
        - scripts/diagnostics/monitor_oauth.sh[checks_discovery_and_auth]
        - scripts/diagnostics/monitor_realtime.go[colored_real_time_logs]
        - scripts/diagnostics/run_diagnostics.sh[comprehensive_check]
      enhanced_logging:
        - oauth_adapter.go[added_[OAuth]_prefixed_logging]
        - oauth_callback_server.go[added_[OAuth_Callback]_logging]
      makefile_commands:
        - make diagnose[run_full_diagnostics]
        - make diagnose-local[test_local_server]
        - make diagnose-prod[check_production]
        - make monitor-oauth[real_time_monitoring]
    status: ✓implemented[ready_for_diagnosis]
    next_steps:
      1. make diagnose-prod  # Check production state
      2. make monitor-oauth  # Run local with monitoring
      3. Try connection in Claude while monitoring
      4. Review logs for actual failure point
  
  oauth_success_notification_fix:
    problem: success_page_shows_but_Claude_still_displays_Connect_button  
    solution: added_window.close_and_postMessage_to_notify_completion
    implementation:
      - added_JavaScript_to_auto_close_window_after_2_seconds
      - sends_postMessage_to_window.opener_if_exists
      - sends_postMessage_to_window.parent_for_iframe_scenarios
      - fallback_message_tells_user_to_close_manually
    files_modified: internal/auth/oauth_callback_server.go
    impact: Claude_now_properly_recognizes_successful_OAuth_completion
    test: deploy_and_test_OAuth_flow_in_Claude.ai
    confidence: medium_low[40%_needs_diagnostic_verification]
    
  oauth_callback_server_fix:
    problem: callback_server_created_but_never_started
    solution: start_server_in_NewOAuthAdapter
    impact: fixes_Claude_OAuth_flow_completion
    file: internal/auth/oauth_adapter.go
    test_fixes: unique_ports_per_test_to_avoid_conflicts
    race_conditions_fixed:
      - captured_local_references_for_server_and_resultChan_in_goroutines
      - proper_mutex_protection_for_channel_lifecycle
      - separated_server_shutdown_from_channel_cleanup
  
  package_declaration_fix:
    problem: tests/scenarios/protocol_test.go declared package integration
    solution: changed to package scenarios to match directory
    impact: fixes go build errors
  
  dual_mode_testing_strategy:
    problem: single_test_suite_cant_test_both_oauth_and_protocol
    solution: separate_test_modes_for_different_concerns
    implementation:
      - general_protocol_tests: run_with_--disable-auth_flag
      - oauth_compliance_tests: run_with_auth_enabled_separately
    files_modified:
      - tests/integration/mcp_integration_test.go[restored_--disable-auth]
      - tests/integration/claude_oauth_compliance_test.go[separate_test_file]
    test_commands:
      protocol: make integration-test
      oauth: go test -v ./tests/integration -run TestClaudeOAuthCompliance

RECENT_FIXES_2025_08_05:
  
  oauth_compliance_complete:
    issues_found:
      - integration_tests_disabled_oauth_with_--disable-auth_flag
      - core_server_missing_charset_stripping_in_middleware
      - core_server_missing_WWW-Authenticate_header_for_401
      - rtm_oauth_mode_missing_discovery_endpoints
    fixes_applied:
      - removed_--disable-auth_from_tests/integration/mcp_integration_test.go
      - added_charset_stripping_to_protocolDetectionMiddleware_in_cmd/core/main.go
      - added_WWW-Authenticate_header_to_rtmAuthMiddleware_401_responses
      - added_/.well-known/*_endpoints_for_RTM_OAuth_mode
    impact: Claude_registration_now_fully_functional
    test_command: go test -v ./tests/integration -run TestClaudeOAuthCompliance

RECENT_FIXES_2025_08_05_EARLIER:
  
  content_type_middleware:
    file: internal/core/infrastructure.go
    issue: mcp-go_v0.32.0_rejects_charset_in_content_type
    fix: middleware_strips_charset_before_reaching_mcp-go
    impact: fixes_claude_registration_and_tests
    
  encoding_fix:
    file: internal/rtm/oauth_adapter.go+setup.go
    issue: emojis_displayed_as_garbled_characters
    fix: added_meta_charset_UTF-8_and_content_type_charset
    status: ✓fixed
  manager_type_assertion:
    file: internal/longrunning/manager.go
    issue: unchecked_type_assertion_could_panic
    fix: added_proper_type_check_for_AdditionalFields
    
  rtm_error_parsing:
    file: internal/rtm/client.go  
    issue: silent_failure_on_error_code_parsing
    fix: preserve_unparseable_code_in_error_message_use_-1_sentinel
    
  token_store_goroutine_leak:
    file: internal/auth/token_store_factory.go
    issue: cleanup_goroutine_never_terminated_on_shutdown
    fix: added_done_channel_and_proper_Close_method
    
  tool_parameter_structs:
    file: internal/rtm/params.go+handlers.go
    issue: raw_map_parameter_extraction_type_unsafe
    fix: created_parameter_structs_for_all_RTM_tools
    benefit: type_safety_cleaner_validation_ready_for_official_SDK

VALID_CODE_ISSUES:
  file_naming:
    - internal/auth/token_store_sqlite.go.removed[use_archive_dir]
    - internal/debug/validation_interceptor.go.disabled[use_build_tags]
    - cmd/test-examples-server/main.go[hyphen_violates_convention]
    priority: P2_CLEANUP
    
  batch_task_cache:
    problem: getCachedTasksByPositions_not_implemented
    file: internal/rtm/batch_handlers.go
    solution: implement_proper_task_cache_after_search
    priority: P2_FUNCTIONALITY

  documentation_improvements:
    status: ✓COMPLETED_2025-08-03
    changes_applied:
      - Added_package_comments_to_all_packages
      - Documented_exported_functions_with_params_and_returns
      - Added_field_docs_to_Client_Task_List_structs
      - Fixed_TODO_format_to_use_TODO(vcto)_standard
      - Improved_Manager_and_Task_documentation
    files_modified: 7

# ARCHIVED_ISSUES moved to docs/HISTORY.md:
# - Race conditions (FIXED 2025-08-03)
# - OAuth flow issues (FIXED 2025-08-02)  
# - Thread safety (FIXED 2025-08-03)
# - Infrastructure gaps (FIXED 2025-07-29)