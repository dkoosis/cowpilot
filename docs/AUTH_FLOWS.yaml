# AUTH_FLOWS.yaml v1.0-claude-optimized
# ✓=works ∅=missing λ=limitation †=workaround ‡=critical ∇=implement
# MACHINE_OPTIMIZED_AUTH_PATTERNS[not_human_readable]

‡RTM_FROB_FLOW:
  TYPE: custom_frob_based[NOT_oauth]
  λCRITICAL: NO_redirect_uri→stays_on_rtm.com
  
  FLOW:
    1_GET_FROB: GET→/services/rest/?method=rtm.auth.getFrob&api_key={KEY}&api_sig={SIG}→{frob}
    2_USER_AUTH: https://rememberthemilk.com/services/auth/?api_key={KEY}&perms={PERMS}&frob={FROB}&api_sig={SIG}
    3_NO_REDIRECT: user_clicks_allow→rtm_shows_success→λNO_CALLBACK
    4_EXCHANGE: GET→/services/rest/?method=rtm.auth.getToken&api_key={KEY}&frob={FROB}&api_sig={SIG}→{token,user}
  
  ‡SIGNATURE: MD5(secret+sorted_params)→params_alpha_sorted→format:secretkey1value1key2value2
  
  †CLAUDE_ADAPTER:
    FAKE_OAUTH: code→frob_mapping[in_memory]
    INTERMEDIATE_PAGE: rtm_popup+manual_continue_button
    POLLING: 2s_interval×5min_timeout→getToken_until_success
    REDIRECT: user_clicks_continue→redirect_to_claude_callback_with_fake_code
  
  CONSTRAINTS:
    FROB_EXPIRY: ~1hr_unused
    TOKEN_EXPIRY: ∅never
    PERMS: read|write|delete
    NO_REFRESH: tokens_permanent
  
  ‡ERRORS:
    98: invalid_signature[check_param_sort]
    101: invalid_frob[expired_or_invalid]
    102: login_required[user_didnt_auth]
  
  ‡RTM_DEBUG_FINDINGS[2025-07-27]:
    ‡RACE_CONDITION_CONFIRMED:
      TIMELINE: callback→redirect(~10ms)→client_token_request
      CLIENT_RESPONSE: {"error":"authorization_pending","error_description":"User has not completed authorization"}
      ROOT_CAUSE: redirect_before_user_completes_rtm_auth
    ‡RTM_API_BEHAVIOR:
      ERROR_101: "Invalid frob - did you authenticate?"
      MEANING: frob_never_authorized_by_user
      POLLING_RESULT: continuously_fails_until_timeout(5min)
    ‡BROKEN_UX_FLOW:
      1. POST_/oauth/authorize→gets_rtm_frob→shows_intermediate_page
      2. user_clicks_rtm_url(new_window)→∅supposed_to_auth_but_doesnt
      3. user_clicks_continue→hits_/rtm/callback
      4. immediate_redirect_to_client
      5. client_calls_/oauth/token→gets_authorization_pending
      6. polling_never_succeeds(frob_invalid)
    ‡PROBLEMS:
      PRIMARY: UX_flow→user_never_completes_rtm_auth
      SECONDARY: race_condition→redirect_too_fast
    ‡FIXES_REQUIRED:
      1. fix_rtm_flow→ensure_user_completes_auth_before_callback
      2. handle_pending→client_retry_OR_wait_synchronously
    ‡KEY_INSIGHT: primary_issue_broken_rtm_auth_flow_not_race_condition

‡SPEKTRIX_HMAC_FLOW:
  TYPE: hmac_sha1_signatures[NOT_oauth]
  ‡CRITICAL: custom_hmac_required[native_google_apps_script_fails]
  
  CREDENTIALS:
    CLIENT_NAME: spektrix_client_name
    API_USER: spektrix_api_username  
    API_KEY: base64_encoded_secret_key
  
  ‡SIGNATURE_GENERATION:
    STRING_TO_SIGN: METHOD\nURL\nDATE\n[MD5_BODY_IF_PRESENT]
    KEY_PROCESSING: base64_decode(api_key)→byte_array→string_conversion
    HMAC: custom_hmac_sha1(string_to_sign,processed_key)→base64_encode
    AUTH_HEADER: "SpektrixAPI3 {API_USER}:{SIGNATURE}"
  
  ‡PAYLOAD_REQUIREMENTS:
    CONTENT_TYPE: "application/json"[required]
    BODY_ENCODING: JSON.stringify()→Utilities.newBlob().getBytes()[byte_array_required]
    MD5_HASH: required_even_for_empty_bodies_in_signature
    DATE_FORMAT: "EEE, dd MMM yyyy HH:mm:ss 'GMT'"[exact_format]
  
  ‡ENDPOINT_PATTERNS[CRITICAL]:
    ✓CORRECT: POST_/customers[plural]
    ❌BROKEN: POST_/customer[singular]→401_unauthorized
    ✓CUSTOMER_CREATE: POST_/customers{firstName,lastName,email}
    ✓ADDRESS_ADD: POST_/customers/{id}/addresses[separate_step]
    ✓CUSTOMER_SEARCH: GET_/customers?email={email}
    ✓TAG_UPDATE: PUT_/customers/{id}/tags[{id:tag_id}]
  
  ‡AUTHENTICATION_MODE:
    REQUIRED: system_owner_permissions
    ❌FAILS: customer_session_mode
  
  λLIMITATIONS:
    NO_TAG_CREATE: tags_must_pre_exist_in_spektrix
    TWO_STEP_CREATE: customer_first→address_separate
    NO_BATCH_OPS: individual_api_calls_required
  
  ‡ERRORS:
    401: [signature_mismatch,wrong_endpoint_pattern,insufficient_permissions]
    400: [malformed_payload,wrong_content_type,invalid_data]
  
  ‡DEBUG_TOOLS[from_sandy_project]:
    SIGNATURE_VERIFICATION: https://integrate.spektrix.com/docs/authentication
    COMPARE_IMPLEMENTATIONS: custom_vs_native_hmac_testing
    ENDPOINT_TESTING: /customers_vs_/customer_validation

GENERIC_OAUTH2[reference]:
  FLOW:
    1_AUTHORIZE: GET→/oauth/authorize?client_id={}&redirect_uri={}&state={}
    2_USER_AUTH: provider_login_page
    3_CALLBACK: redirect→{redirect_uri}?code={}&state={}
    4_EXCHANGE: POST→/oauth/token{grant_type:authorization_code,code,client_id,client_secret}→{access_token}
  
  ✓FEATURES: [redirect_uri,state_param,refresh_tokens,token_expiry]
  
  ‡CLAUDE_AI_OAUTH_PATHS[LEARNED_2025-07-27]:
    EXPECTS: /authorize+/token[NOT_/oauth/authorize]
    STANDARD_PATHS: /oauth/authorize+/oauth/token
    SOLUTION: support_both_endpoint_patterns

‡MCP_OAUTH_PROTOCOL[claude_ai_requirements_2025-07-30]:
  TYPE: rfc_9728_protected_resource_metadata+rfc_8414_auth_server_metadata
  ‡CRITICAL: exact_protocol_contract_compliance_required
  
  ‡CLAUDE_AI_CONNECT_BUTTON_FLOW:
    TRIGGER: 401_response_with_WWW-Authenticate_header
    1_DISCOVERY: GET→/mcp→401+WWW-Authenticate:Bearer_realm="{server}/.well-known/oauth-protected-resource"
    2_PROTECTED_RESOURCE: GET→/.well-known/oauth-protected-resource→{authorization_servers,resource,scopes}
    3_AUTH_SERVER: GET→/.well-known/oauth-authorization-server→{authorization_endpoint,token_endpoint,etc}
    4_OAUTH_FLOW: standard_oauth2_authorization_code_flow
  
  ‡REQUIRED_ENDPOINTS[all_must_work]:
    /.well-known/oauth-protected-resource: rfc_9728_metadata
    /.well-known/oauth-authorization-server: rfc_8414_metadata  
    /authorize: oauth_authorization_endpoint
    /token: oauth_token_endpoint
    /mcp: protected_resource[401_if_unauthorized]
  
  ‡CRITICAL_401_RESPONSE[learned_twice_do_not_break]:
    STATUS: HTTP_401_Unauthorized
    HEADER: WWW-Authenticate:Bearer_realm="{serverURL}/.well-known/oauth-protected-resource"
    BODY: any_error_message
    PURPOSE: triggers_claude_ai_oauth_discovery
    ‡WARNING: remove_this_header→connect_button_disappears
  
  ‡RFC_9728_PROTECTED_RESOURCE_METADATA[/.well-known/oauth-protected-resource]:
    authorization_servers: ["https://rtm.fly.dev"]
    resource: "https://rtm.fly.dev/mcp"
    scopes_supported: ["rtm:read","rtm:write"]
  
  ‡RFC_8414_AUTH_SERVER_METADATA[/.well-known/oauth-authorization-server]:
    issuer: "https://rtm.fly.dev"
    authorization_endpoint: "https://rtm.fly.dev/authorize"
    token_endpoint: "https://rtm.fly.dev/token"
    scopes_supported: ["rtm:read","rtm:write"]
    response_types_supported: ["code"]
    grant_types_supported: ["authorization_code"]
    resource_indicators_supported: true
  
  ‡CORS_REQUIREMENTS:
    SKIP_CORS: [/oauth/*,/.well-known/*,/authorize,/token,/health]
    REASON: claude_ai_cross_origin_oauth_discovery
    DEFAULT_ALLOW: https://claude.ai
  
  ‡PROTOCOL_CONTRACT_ISSUE[discovered_2025-07-30]:
    STATUS: ❌connect_button_shows→oauth_flow_fails→"error_connecting"
    SYMPTOMS: endpoints_work→parameters_populate→but_flow_breaks
    HYPOTHESIS: protocol_violation_in_oauth_response_format_or_flow
    ‡TODO: debug_exact_contract_violation
  
  ‡AUTH_MIDDLEWARE_REQUIREMENTS:
    SKIP_PATHS: [/oauth/*,/rtm/*,/.well-known/*,/health,/logo,/authorize,/token]
    MCP_ENDPOINT: requires_auth[bearer_token]
    AUTH_HEADER: "Authorization:Bearer_{token}"
    VALIDATION: rtm_api_call_to_verify_token
  
  ‡LEARNED_TWICE_DO_NOT_FORGET:
    1. WWW-Authenticate_header→critical_for_connect_button
    2. CORS_must_skip_oauth_endpoints
    3. exact_endpoint_paths_matter
    4. protocol_contract_compliance_essential
  
  ‡CLAUDE_AI_UI_CHANGES[noted_2025-07-30]:
    NEW: manual_oauth_client_id+secret_input_fields
    OLD: auto_discovery_only
    IMPACT: may_change_flow_expectations
  
  ‡MCP_SPEC_EVOLUTION[june_2025]:
    CHANGE: auth_server_separate_from_mcp_server
    OLD: march_2025→mcp_server_as_auth_server
    NEW: june_2025→dedicated_auth_server_recommended
    CURRENT: cowpilot_follows_old_pattern→may_need_migration
